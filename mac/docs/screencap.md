# Screen Capture (Screencap) Feature

## Overview

VibeTunnel's screen capture feature allows users to share their Mac screen through a web browser using WebRTC technology. This enables real-time screen sharing with low latency and high quality video streaming.

## Architecture

### Components

1. **ScreencapService** (`mac/VibeTunnel/Core/Services/ScreencapService.swift`)
   - Singleton service that manages screen capture functionality
   - Handles WebSocket connection for API requests with automatic reconnection
   - Manages capture sessions using ScreenCaptureKit
   - Provides API endpoints for window/display enumeration and control
   - Supports process grouping with app icons

2. **WebRTCManager** (`mac/VibeTunnel/Core/Services/WebRTCManager.swift`)
   - Manages WebRTC peer connections
   - Handles signaling via WebSocket with authentication
   - Processes video frames from ScreenCaptureKit
   - Supports H.264 and H.265 video codecs
   - Implements session-based security for control operations

3. **Web Frontend** (`web/src/client/components/screencap-view.ts`)
   - LitElement-based UI for screen capture
   - WebRTC client for receiving video streams
   - API client for controlling capture sessions
   - Session management for secure control operations

4. **Signaling Server** (`web/src/server/websocket/screencap-signal-handler.ts`)
   - WebSocket server at `/ws/screencap-signal`
   - Facilitates WebRTC signaling between Mac app and browser
   - Routes API requests between browser and Mac app
   - Forwards session IDs for security validation

### Communication Flow

```
Browser <--WebSocket--> Node.js Server <--WebSocket--> Mac App
        <--WebRTC P2P------------------------->
```

1. Browser connects to `/ws/screencap-signal`
2. Mac app connects to the same WebSocket endpoint with authentication
3. Browser requests screen capture via API
4. Mac app creates WebRTC offer and sends through signaling
5. Browser responds with answer
6. P2P connection established for video streaming

## Features

### Capture Modes

- **Desktop Capture**: Share entire display(s)
- **Window Capture**: Share specific application windows  
- **Multi-display Support**: Handle multiple monitors
- **Process Grouping**: View windows grouped by application with icons

### Security

- **Authentication**: WebSocket connections require authentication
  - Local connections use `X-VibeTunnel-Local` header with auth token
  - Remote connections use standard VibeTunnel authentication
  - Token is dynamically updated if not available during initial connection
- **Permissions**: Requires macOS Screen Recording permission
- **Session Management**: 
  - Each capture session has unique ID for security
  - Session IDs are generated by the browser client
  - Control operations (click, key, capture) require valid session
  - Session is initialized when capture starts
  - Session is cleared when capture stops

### Video Quality

- **Codec Support**: 
  - H.265/HEVC (preferred on Apple Silicon)
  - H.264/AVC (fallback)
- **Adaptive Quality**: Adjusts based on network conditions
- **Hardware Acceleration**: Uses VideoToolbox for efficient encoding

## Implementation Details

### WebSocket Reconnection

The screencap service implements automatic WebSocket reconnection to ensure reliability:

1. **Initial Connection**: Attempts connection when service is created (singleton pattern)
2. **Automatic Retry**: Reconnects after 2 seconds if connection fails
3. **Connection Monitoring**: Checks connection status every 5 seconds
4. **Dynamic Auth Token**: Updates authentication if token wasn't available initially
5. **Connection State Tracking**: Maintains connection state to prevent duplicate connections
6. **Continuation Management**: Queues requests while connection is being established

### API Endpoints (via WebSocket)

All API requests are sent through the WebSocket connection as `api-request` messages:

- `GET /displays` - List available displays with names and positions
- `GET /processes` - List process groups with windows and app icons
- `POST /capture` - Start screen capture (desktop or all displays)
  - Parameters: `type: "desktop"`, `index: number`, `webrtc?: boolean`
  - Requires session ID for authorization
- `POST /capture-window` - Start window capture by cgWindowID
  - Parameters: `cgWindowID: number`, `webrtc?: boolean`
  - Requires session ID for authorization
- `POST /stop` - Stop screen capture and clear session
- `POST /click` - Simulate mouse click (requires session)
  - Parameters: `x: number`, `y: number` (0-1000 normalized range)
- `POST /mousedown` - Mouse down event (requires session)
- `POST /mousemove` - Mouse move/drag event (requires session)
- `POST /mouseup` - Mouse up event (requires session)
- `POST /key` - Simulate keyboard input (requires session)
  - Parameters: `key: string`, modifier flags

### Error Handling

Common errors and their handling:

- **No Permission**: Prompts user to grant Screen Recording permission
- **WebSocket Disconnection**: Automatic reconnection with 2-second delay
- **Invalid Window/Display**: Returns appropriate error message
- **Capture Failure**: Logs error and notifies client
- **Session Errors**: "Unauthorized: Invalid session" for control operations without valid session
- **JSON Serialization**: Converts Swift Codable types to dictionaries for WebSocket transport
- **Browser Compatibility**: Fallback for browsers without crypto.randomUUID support

## Usage

### Accessing Screen Capture

1. Ensure VibeTunnel server is running
2. Navigate to `http://localhost:4020/screencap` in a web browser
3. Grant Screen Recording permission if prompted
4. Select capture mode (desktop or window)
5. Click "Start Capture" to begin sharing

### Prerequisites

- macOS 14.0 or later
- Screen Recording permission granted to VibeTunnel
- Modern web browser with WebRTC support
- Screencap feature enabled in VibeTunnel settings

### Troubleshooting

**"Failed to load windows" error**
- Ensure Screen Recording permission is granted in System Settings
- Check that WebSocket connection is established (see server logs)
- Verify server is running with screencap enabled
- The service will automatically retry connection every 2 seconds

**"Unauthorized: Invalid session" error**
- This happens when clicking on displays/windows before a session is established
- The browser client generates a session ID when starting capture
- Ensure the session ID is being forwarded through the WebSocket connection
- Check that the Mac app is initializing the session on capture start

**Black screen or no video**
- Check browser console for WebRTC errors
- Ensure firewall isn't blocking WebRTC connections
- Try refreshing the page
- Verify H.265/H.264 codec support in browser

**Connection timeouts**
- The Mac app connects to WebSocket when ScreencapService is initialized
- If auth token isn't available initially, it will be updated when server starts
- Connection state is tracked to prevent duplicate connections
- Check server logs for authentication errors

**crypto.randomUUID is not a function**
- This error occurs in older browsers
- The code includes a fallback using Date.now() and Math.random()
- Should work in all modern browsers now

## Development

### Key Implementation Details

1. **Singleton Pattern**: ScreencapService uses singleton to ensure WebSocket connection on startup
2. **Non-Sendable Types**: CMSampleBuffer handled with `processVideoFrameSync` to avoid data races
3. **JSON Serialization**: Swift Codable types converted to dictionaries before WebSocket transport
4. **Session Flow**: Browser generates ID → Server forwards → Mac validates → Operations allowed
5. **Coordinate System**: Browser uses 0-1000 normalized range, Mac converts to pixel coordinates

### Adding New Features

1. **Mac Side**: Extend `ScreencapService` with new methods
2. **API**: Add handler in `processApiRequest` method in WebRTCManager
3. **Web Side**: Update `ScreencapApiClient` with new endpoints
4. **UI**: Modify `screencap-view.ts` for new controls
5. **Security**: Add to control endpoints list if operation requires session

### Testing

- Use Chrome DevTools for WebRTC debugging
- Monitor WebSocket frames in Network tab
- Check `about:webrtc` in Firefox for detailed stats
- Enable debug logging with `VIBETUNNEL_DEBUG=1`
- Test session flow: Start capture → Verify session ID → Test control operations

### Security Considerations

- Always validate input parameters (coordinate ranges, key input length)
- Sanitize window/display IDs before use
- Rate limit API requests to prevent abuse
- Log security-relevant events with timestamps (audit trail)
- Session-based authorization for all control operations
- Session IDs must match between request and active session
- Sessions are cleared when capture stops
- Control operations include: click, key, mouse events, capture start/stop

## Future Enhancements

- Audio capture support
- Multi-user screen sharing
- Recording capabilities
- Annotation tools
- Remote desktop control (full mouse/keyboard)